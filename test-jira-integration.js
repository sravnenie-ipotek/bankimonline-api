const crypto = require('crypto');
const axios = require('axios');
const FormData = require('form-data');
const dotenv = require('dotenv');
const fs = require('fs');
const path = require('path');

// Load environment variables
dotenv.config();

// Jira integration functions (copied from cypress.config.ts)
function jiraClient() {
  const baseURL = process.env.JIRA_HOST;
  const auth = Buffer.from(
    `${process.env.JIRA_EMAIL}:${process.env.JIRA_API_TOKEN}`
  ).toString('base64');

  const api = axios.create({
    baseURL,
    headers: {
      Authorization: `Basic ${auth}`,
      Accept: 'application/json',
      'Content-Type': 'application/json',
    },
  });

  async function createIssue({ projectKey, summary, description, issueType, labels }) {
    const payload = {
      fields: {
        project: { key: projectKey },
        summary,
        description,
        issuetype: { name: issueType || '–ë–∞–≥' },
        labels: labels || [],
      },
    };
    const res = await api.post('/rest/api/3/issue', payload);
    return res.data.key;
  }

  return { createIssue };
}

/** Create a short, stable fingerprint for the failure */
function buildFingerprint({ projectKey, spec, testTitle, errorMessage }) {
  const raw = `${projectKey}::${spec}::${testTitle}::${(errorMessage || '').slice(0,400)}`;
  return 'cfp_' + crypto.createHash('sha1').update(raw).digest('hex').slice(0, 10);
}

// Simulate a realistic Cypress test failure
async function createDemoJiraBug() {
  console.log('üöÄ Starting Demo Jira Bug Creation...');
  
  const projectKey = process.env.JIRA_PROJECT_KEY || 'TVKC';
  const issueType = process.env.JIRA_ISSUE_TYPE || '–ë–∞–≥';
  
  // Simulated test failure data
  const testData = {
    spec: 'cypress/e2e/mortgage/step2.cy.ts',
    testTitle: 'Mortgage Calculator Step 2 - Property Ownership Validation',
    errorMessage: 'AssertionError: expected property ownership dropdown to contain option "I don\'t own property" but got "undefined"',
    appUrl: 'http://localhost:5174',
    browser: 'Chrome 120.0.6099.129',
    os: 'darwin x64',
    currentUrl: 'http://localhost:5174/services/calculate-mortgage/2',
    filePath: 'cypress/e2e/mortgage/step2.cy.ts',
    actionLog: [
      '[2024-08-15T11:52:30.000Z] Test started: Mortgage Calculator Step 2',
      '[2024-08-15T11:52:30.300Z] visit: ["/services/calculate-mortgage/2"]',
      '[2024-08-15T11:52:31.000Z] get: ["[data-testid=\\"property-ownership-dropdown\\"]"]',
      '[2024-08-15T11:52:31.400Z] should: ["be.visible"]',
      '[2024-08-15T11:52:31.800Z] get: ["[data-testid=\\"property-ownership-dropdown\\"] option"]',
      '[2024-08-15T11:52:32.200Z] should: ["contain.text","I don\'t own property"]',
      '[2024-08-15T11:52:32.600Z] FAILED - should: AssertionError: expected option text',
      '[2024-08-15T11:52:33.000Z] URL changed to: /services/calculate-mortgage/2',
      '[2024-08-15T11:52:33.400Z] Test failed: Property ownership dropdown validation failed'
    ],
    testSteps: [
      { action: 'visit', args: ['/services/calculate-mortgage/2'], timestamp: '2024-08-15T11:52:30.300Z', success: true },
      { action: 'get', selector: '[data-testid="property-ownership-dropdown"]', timestamp: '2024-08-15T11:52:31.000Z', success: true },
      { action: 'should', args: ['be.visible'], timestamp: '2024-08-15T11:52:31.400Z', success: true },
      { action: 'get', selector: '[data-testid="property-ownership-dropdown"] option', timestamp: '2024-08-15T11:52:31.800Z', success: true },
      { action: 'should', args: ['contain.text', "I don't own property"], timestamp: '2024-08-15T11:52:32.200Z', success: false, error: 'AssertionError: expected option text' }
    ]
  };

  try {
    const client = jiraClient();
    const fingerprint = buildFingerprint({ projectKey, spec: testData.spec, testTitle: testData.testTitle, errorMessage: testData.errorMessage });
    const timestamp = new Date().toISOString();

    console.log(`üìç Creating bug with fingerprint: ${fingerprint}`);

    const summary = `üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô: –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | CRITICAL: Property ownership dropdown not working`;
    
    // Create comprehensive bilingual ADF description with clear explanations
    const description = {
      "type": "doc",
      "version": 1,
      "content": [
        {
          "type": "heading",
          "attrs": { "level": 1 },
          "content": [{ "type": "text", "text": "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –í –ò–ü–û–¢–ï–ß–ù–û–ú –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ï | CRITICAL MORTGAGE CALCULATOR BUG" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "error" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –ü–†–û–ë–õ–ï–ú–ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ù–ï –ú–û–ì–£–¢ –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –∏–ø–æ—Ç–µ—á–Ω–æ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ. –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã, –±–ª–æ–∫–∏—Ä—É—è –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—á–µ—Ç–∞ –∏–ø–æ—Ç–µ–∫–∏.", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ ISSUE: Users CANNOT select property ownership type in mortgage calculator. The dropdown does not show options, blocking the entire mortgage calculation process.", "marks": [{ "type": "strong" }] }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üë• –í–õ–ò–Ø–ù–ò–ï –ù–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô | USER IMPACT" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "warning" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –°–ï–†–¨–ï–ó–ù–û–°–¢–¨: –í–´–°–û–ö–ê–Ø - –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –º–æ–≥—É—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∏–ø–æ—Ç–µ–∫–∏ –ø–æ—Å–ª–µ 2-–≥–æ —à–∞–≥–∞", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –ü–æ—Ç–µ—Ä—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑-–∑–∞ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ –±–∞–Ω–∫–∞" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ SEVERITY: HIGH - Customers cannot proceed with mortgage calculation after step 2", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Customer loss due to broken calculator" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Unable to get preliminary calculations" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Reduced conversion on bank website" }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üîç –ß–¢–û –ò–ú–ï–ù–ù–û –°–õ–û–ú–ê–ù–û | WHAT EXACTLY IS BROKEN" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "info" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –°–£–¢–¨:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "–í –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ '–¢–∏–ø —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏' –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ '–£ –º–µ–Ω—è –Ω–µ—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏' (75% —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ '–£ –º–µ–Ω—è –µ—Å—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å' (50% —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ '–ü—Ä–æ–¥–∞—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å' (70% —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ TECHNICAL DETAILS:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "Property ownership dropdown is missing required options:" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ 'I don't own property' (75% financing)", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ 'I own property' (50% financing)", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ 'Selling property' (70% financing)", "marks": [{ "type": "code" }] }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üìã –ö–ê–ö –í–û–°–ü–†–û–ò–ó–í–ï–°–¢–ò –ü–†–û–ë–õ–ï–ú–£ | HOW TO REPRODUCE" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "note" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –ü–û–®–ê–ì–û–í–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–ø–æ—Ç–µ—á–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä: " },
                { "type": "text", "text": "http://localhost:5174/services/calculate-mortgage/2", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. –ù–∞–π–¥–∏—Ç–µ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ '–¢–∏–ø —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏'" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –ª—é–±–æ–π –≤–∞—Ä–∏–∞–Ω—Ç" },
                { "type": "hardBreak" },
                { "type": "text", "text": "4. ‚ùå –†–ï–ó–£–õ–¨–¢–ê–¢: –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 'undefined'" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ STEP-BY-STEP INSTRUCTIONS:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. Open mortgage calculator: " },
                { "type": "text", "text": "http://localhost:5174/services/calculate-mortgage/2", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. Find the 'Property Ownership' dropdown" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. Try to select any option" },
                { "type": "hardBreak" },
                { "type": "text", "text": "4. ‚ùå RESULT: Options are missing or show 'undefined'" }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üì∏ –°–ö–†–ò–ù–®–û–¢ –ü–†–û–ë–õ–ï–ú–´ | SCREENSHOT OF ISSUE" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "note" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –í–ò–ó–£–ê–õ–¨–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "–°–∫—Ä–∏–Ω—à–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –ü—É—Å—Ç–æ–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤–º–µ—Å—Ç–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –ö–Ω–æ–ø–∫–∞ '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞: 'dropdown options undefined'" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ VISUAL CONFIRMATION:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "Screenshot shows:" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Empty dropdown instead of property ownership options" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ 'Continue' button is disabled/inactive" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Browser console error: 'dropdown options undefined'" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üì∏ –í —Ä–µ–∞–ª—å–Ω–æ–º —Ç–µ—Å—Ç–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω —Å–∫—Ä–∏–Ω—à–æ—Ç | In real test, screenshot would be attached here", "marks": [{ "type": "em" }] }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üí° –ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï | QUICK FIX" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "success" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–û–í:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API endpoint: " },
                { "type": "text", "text": "/api/v1/calculation-parameters?business_path=mortgage", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ property_ownership_ltvs –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: " },
                { "type": "text", "text": "PropertyOwnershipDropdown.tsx", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ FOR DEVELOPERS:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "1. Check API endpoint: " },
                { "type": "text", "text": "/api/v1/calculation-parameters?business_path=mortgage", "marks": [{ "type": "code" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "2. Ensure property_ownership_ltvs returns correct data" },
                { "type": "hardBreak" },
                { "type": "text", "text": "3. Check component: " },
                { "type": "text", "text": "PropertyOwnershipDropdown.tsx", "marks": [{ "type": "code" }] }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 2 },
          "content": [{ "type": "text", "text": "üìç –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø | TECHNICAL INFORMATION" }]
        },
        {
          "type": "table",
          "attrs": {
            "isNumberColumnEnabled": false,
            "layout": "default"
          },
          "content": [
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableHeader",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Field | –ü–æ–ª–µ" }] }]
                },
                {
                  "type": "tableHeader", 
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Value | –ó–Ω–∞—á–µ–Ω–∏–µ" }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Spec File | –§–∞–π–ª —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": testData.spec, "marks": [{ "type": "code" }] }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Test Title | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": testData.testTitle, "marks": [{ "type": "code" }] }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "File Path | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": testData.filePath, "marks": [{ "type": "code" }] }] }]
                }
              ]
            },
            {
              "type": "tableRow",
              "content": [
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": "Current URL | –¢–µ–∫—É—â–∏–π URL" }] }]
                },
                {
                  "type": "tableCell",
                  "content": [{ "type": "paragraph", "content": [{ "type": "text", "text": testData.currentUrl, "marks": [{ "type": "code" }] }] }]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üñ•Ô∏è Environment | –û–∫—Ä—É–∂–µ–Ω–∏–µ" }]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Browser | –ë—Ä–∞—É–∑–µ—Ä: " + testData.browser }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Operating System | –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: " + testData.os }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Timestamp | –í—Ä–µ–º—è: " + timestamp }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "‚ùå –î–ï–¢–ê–õ–ò –û–®–ò–ë–ö–ò | ERROR DETAILS" }]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "error" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üá∑üá∫ –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –æ–∂–∏–¥–∞–ª –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç '–£ –º–µ–Ω—è –Ω–µ—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏' –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ, –Ω–æ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –Ω–∞—à–µ–ª 'undefined'. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å." },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ TECHNICAL ERROR:", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "Automated test expected to find text 'I don't own property' in dropdown but found 'undefined' instead. This means data is not loading from server or component cannot process it." }
              ]
            }
          ]
        },
        {
          "type": "codeBlock",
          "attrs": { "language": "javascript" },
          "content": [{ "type": "text", "text": "CYPRESS TEST ERROR:\n" + testData.errorMessage + "\n\nLOCATION: cypress/e2e/mortgage/step2.cy.ts:45\nELEMENT: [data-testid='property-ownership-dropdown'] option\nEXPECTED: 'I don\\'t own property'\nACTUAL: 'undefined'" }]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üìã Test Steps | –®–∞–≥–∏ —Ç–µ—Å—Ç–∞" }]
        },
        {
          "type": "orderedList",
          "content": testData.testSteps.map((step, index) => ({
            "type": "listItem",
            "content": [
              {
                "type": "paragraph",
                "content": [
                  { "type": "text", "text": `${step.action}`, "marks": step.success === false ? [{ "type": "strong" }, { "type": "textColor", "attrs": { "color": "#DE350B" } }] : [] },
                  step.selector ? { "type": "text", "text": ` (${step.selector})`, "marks": [{ "type": "code" }] } : null,
                  step.args ? { "type": "text", "text": ` args: ${JSON.stringify(step.args)}`, "marks": [{ "type": "code" }] } : null
                ].filter(Boolean)
              }
            ]
          }))
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üîç Action Log | –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π" }]
        },
        {
          "type": "codeBlock",
          "attrs": { "language": "text" },
          "content": [{ "type": "text", "text": testData.actionLog.join('\n') }]
        },
        {
          "type": "heading",
          "attrs": { "level": 3 },
          "content": [{ "type": "text", "text": "üîß Debug Information | –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" }]
        },
        {
          "type": "bulletList",
          "content": [
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Fingerprint | –û—Ç–ø–µ—á–∞—Ç–æ–∫: " },
                    { "type": "text", "text": fingerprint, "marks": [{ "type": "code" }] }
                  ]
                }
              ]
            },
            {
              "type": "listItem",
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    { "type": "text", "text": "Screenshots attached | –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã —Å–∫—Ä–∏–Ω—à–æ—Ç—ã: Would be attached in real test | –ë—ã–ª–∏ –±—ã –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ç–µ—Å—Ç–µ" }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "panel",
          "attrs": { "panelType": "info" },
          "content": [
            {
              "type": "paragraph",
              "content": [
                { "type": "text", "text": "üîß –í–ê–ñ–ù–û –î–õ–Ø –ö–û–ú–ê–ù–î–´ | IMPORTANT FOR TEAM", "marks": [{ "type": "strong" }] },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∑üá∫ –≠—Ç–æ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–û–ù–ù–´–ô –±–∞–≥, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π Cypress –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Jira. –í —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–±–æ—è—Ö —Ç–µ—Å—Ç–æ–≤:", "marks": [{ "type": "em" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—é—Ç—Å—è —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤–∏–¥–µ–æ–∑–∞–ø–∏—Å–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–≥–∏ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ –°–æ–∑–¥–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π" },
                { "type": "hardBreak" },
                { "type": "hardBreak" },
                { "type": "text", "text": "üá∫üá∏ This is a DEMO bug created automatically by Cypress system to showcase Jira integration capabilities. In real test failures:", "marks": [{ "type": "em" }] },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ High-resolution screenshots are automatically attached" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Test execution videos are included" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Browser console logs are saved" },
                { "type": "hardBreak" },
                { "type": "text", "text": "‚Ä¢ Unique fingerprint prevents duplicate bugs" }
              ]
            }
          ]
        }
      ]
    };

    const labels = [fingerprint, 'cypress', 'auto-filed', 'demo', 'mortgage-calculator', 'bilingual'];
    
    console.log('üéØ Creating Jira issue...');
    const issueKey = await client.createIssue({
      projectKey,
      summary,
      description,
      issueType,
      labels,
    });

    console.log(`‚úÖ SUCCESS! Jira bug created: https://bankimonline.atlassian.net/browse/${issueKey}`);
    console.log(`üìç Bug details: https://bankimonline.atlassian.net/browse/${issueKey}`);
    console.log(`üîß Fingerprint: ${fingerprint}`);
    
    return { issueKey, fingerprint };
  } catch (error) {
    console.error('‚ùå Jira integration error:', error.message);
    if (error.response) {
      console.error('Response data:', error.response.data);
      console.error('Response status:', error.response.status);
    }
    return { error: error.message };
  }
}

// Run the demo
createDemoJiraBug().then(result => {
  if (result.issueKey) {
    console.log('\nüéâ Demo completed successfully!');
    console.log('üîó View the created bug:', `https://bankimonline.atlassian.net/browse/${result.issueKey}`);
    console.log('\nThe bug includes:');
    console.log('‚úÖ Exact file path: cypress/e2e/mortgage/step2.cy.ts');
    console.log('‚úÖ Complete action log with timestamps');
    console.log('‚úÖ Structured test steps with success/failure status');
    console.log('‚úÖ Full environment context');
    console.log('‚úÖ Bilingual description (English/Russian)');
    console.log('‚úÖ Smart deduplication fingerprint');
  } else {
    console.log('\n‚ùå Demo failed:', result.error);
  }
}).catch(console.error);